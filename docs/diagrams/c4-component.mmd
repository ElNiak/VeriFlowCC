%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#ff6b6b', 'primaryTextColor':'#fff', 'primaryBorderColor':'#ff4757', 'lineColor':'#5f86c9', 'secondaryColor':'#4ecdc4', 'tertiaryColor':'#95e1d3'}}}%%

C4Component
    title Component diagram for Orchestrator Container

    Container_Boundary(orchestrator, "Workflow Orchestrator") {
        Component(state_machine, "State Machine", "Python", "Manages V-Model stage transitions")
        Component(task_queue, "Task Queue", "Python/asyncio", "Manages task execution order")
        Component(gate_validator, "Gate Validator", "Python", "Validates stage completion criteria")
        Component(checkpoint_mgr, "Checkpoint Manager", "Python", "Creates and manages git checkpoints")
        Component(error_handler, "Error Handler", "Python", "Handles failures and retry logic")
        Component(progress_tracker, "Progress Tracker", "Python", "Tracks execution progress")
    }

    Container_Boundary(agents, "Agent Modules") {
        Component(base_agent, "Base Agent", "Python ABC", "Abstract base class for all agents")
        Component(planner_impl, "Planner Implementation", "Python", "Opus 4.1 planning logic")
        Component(design_impl, "Design Agent", "Python", "Sonnet 4 design generation")
        Component(coding_impl, "Coding Agent", "Python", "Sonnet 4 code generation")
        Component(testing_impl, "Testing Agent", "Python", "Sonnet 4 test execution")
        Component(validation_impl, "Validation Agent", "Python", "Opus 4.1 validation logic")
    }

    Container_Ext(claude_sdk, "Claude SDK", "Python Library")
    Container_Ext(schemas, "Pydantic Schemas", "Data Models")
    Container_Ext(prompts, "Jinja2 Templates", "Prompt Templates")

    Rel(state_machine, task_queue, "Enqueues tasks", "Internal")
    Rel(task_queue, base_agent, "Executes", "Polymorphic calls")
    Rel(base_agent, planner_impl, "Inherits", "OOP")
    Rel(base_agent, design_impl, "Inherits", "OOP")
    Rel(base_agent, coding_impl, "Inherits", "OOP")
    Rel(base_agent, testing_impl, "Inherits", "OOP")
    Rel(base_agent, validation_impl, "Inherits", "OOP")

    Rel(state_machine, gate_validator, "Checks gates", "Function calls")
    Rel(gate_validator, schemas, "Validates", "Pydantic")
    Rel(state_machine, checkpoint_mgr, "Creates checkpoints", "Internal")
    Rel(error_handler, task_queue, "Retries tasks", "Internal")
    Rel(progress_tracker, state_machine, "Monitors", "Observer pattern")

    Rel(planner_impl, claude_sdk, "API calls", "HTTPS")
    Rel(design_impl, claude_sdk, "API calls", "HTTPS")
    Rel(coding_impl, claude_sdk, "API calls", "HTTPS")
    Rel(testing_impl, claude_sdk, "API calls", "HTTPS")
    Rel(validation_impl, claude_sdk, "API calls", "HTTPS")

    Rel(planner_impl, prompts, "Renders", "Jinja2")
    Rel(design_impl, prompts, "Renders", "Jinja2")
    Rel(coding_impl, prompts, "Renders", "Jinja2")
    Rel(testing_impl, prompts, "Renders", "Jinja2")
    Rel(validation_impl, prompts, "Renders", "Jinja2")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="2")
